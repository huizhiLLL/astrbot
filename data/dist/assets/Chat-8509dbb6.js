import{I as Ce,ac as Me,u as Oe,z as g,o as r,g as P,p as I,b as t,w as o,l as O,e as D,t as N,C as V,A as k,a as $,f as n,a0 as rt,n as Le,F as ae,h as ce,V as _e,j as dt,E as Ve,d as ye,q as be,B as Se,M as se,aw as ct,s as ut,G as Ie,H as xe,a5 as F,k as ue,N as ke,P as re,$ as Be,a1 as je,L as Fe,a2 as we,c as ve,x as We,bf as Ke,R as vt,bg as mt,m as de,aq as te,ai as pt,aU as He,au as Ne,a7 as gt,J as ft,ao as Ee,O as ze,ar as ht,aR as _t}from"./index-77b120c5.js";import{useCustomizerStore as Ae}from"./customizer-13facaf4.js";import{L as yt}from"./LanguageSwitcher-3999e8c5.js";import{M as bt}from"./MessageList-6cf74015.js";import{_ as St}from"./icon-no-shadow-0b6d3dea.js";import{_ as me}from"./_plugin-vue_export-helper-c27b6911.js";import{u as kt}from"./toast-0c57477c.js";const wt=i=>(Ie("data-v-014bf03f"),i=i(),xe(),i),Ct={key:0,style:{display:"flex","align-items":"center","justify-content":"center",padding:"16px","padding-bottom":"0px"}},Mt=wt(()=>k("img",{width:"50",src:St,alt:"AstrBot Logo"},null,-1)),It={key:0,style:{"font-weight":"1000","font-size":"26px","margin-left":"8px"}},xt={key:1,class:"sidebar-collapse-btn-container"},Pt={key:2,class:"sidebar-collapse-btn-container"},Tt={style:{padding:"16px","padding-top":"8px"}},Rt={key:3},Dt={class:"conversation-actions"},Ut={key:0,class:"no-conversations"},$t={key:0,class:"no-conversations-text"},Lt=100,Vt=Ce({__name:"ConversationSidebar",props:{sessions:{},selectedSessions:{},currSessionId:{},isDark:{type:Boolean},chatboxMode:{type:Boolean},isMobile:{type:Boolean},mobileMenuOpen:{type:Boolean}},emits:["newChat","selectConversation","editTitle","deleteConversation","closeMobileSidebar"],setup(i,{emit:c}){const u=i,{tm:b}=Me("features/chat");Oe();const e=g(!0),d=g(!1),l=g(null),h=g(!1),M=localStorage.getItem("sidebarCollapsed");M!==null?e.value=JSON.parse(M):e.value=!0;function T(){if(h.value){h.value=!1;return}e.value=!e.value,localStorage.setItem("sidebarCollapsed",JSON.stringify(e.value))}function U(){!e.value||u.isMobile||(d.value=!0,l.value=window.setTimeout(()=>{d.value&&(h.value=!0,e.value=!1)},Lt))}function v(){d.value=!1,l.value&&(clearTimeout(l.value),l.value=null),h.value&&(e.value=!0),h.value=!1}return(s,f)=>(r(),P("div",{class:Le(["sidebar-panel",{"sidebar-collapsed":e.value&&!s.isMobile,"mobile-sidebar-open":s.isMobile&&s.mobileMenuOpen,"mobile-sidebar":s.isMobile}]),style:ut({"background-color":s.isDark?e.value?"#1e1e1e":"#2d2d2d":e.value?"#ffffff":"#f1f4f9"}),onMouseenter:U,onMouseleave:v},[s.chatboxMode?(r(),P("div",Ct,[Mt,e.value?I("",!0):(r(),P("span",It,"AstrBot"))])):I("",!0),s.isMobile?I("",!0):(r(),P("div",xt,[t(V,{icon:"",class:"sidebar-collapse-btn",onClick:T,variant:"text",color:"deep-purple"},{default:o(()=>[t(O,null,{default:o(()=>[D(N(e.value||!e.value&&h.value?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1})])),s.isMobile?(r(),P("div",Pt,[t(V,{icon:"",class:"sidebar-collapse-btn",onClick:f[0]||(f[0]=m=>s.$emit("closeMobileSidebar")),variant:"text",color:"deep-purple"},{default:o(()=>[t(O,null,{default:o(()=>[D("mdi-close")]),_:1})]),_:1})])):I("",!0),k("div",Tt,[!e.value||s.isMobile?(r(),$(V,{key:0,block:"",variant:"text",class:"new-chat-btn",onClick:f[1]||(f[1]=m=>s.$emit("newChat")),disabled:!s.currSessionId,"prepend-icon":"mdi-plus",style:{"background-color":"transparent !important","border-radius":"4px"}},{default:o(()=>[D(N(n(b)("actions.newChat")),1)]),_:1},8,["disabled"])):I("",!0),e.value&&!s.isMobile?(r(),$(V,{key:1,icon:"mdi-plus",rounded:"lg",onClick:f[2]||(f[2]=m=>s.$emit("newChat")),disabled:!s.currSessionId,elevation:"0"},null,8,["disabled"])):I("",!0)]),!e.value||s.isMobile?(r(),P("div",Rt,[t(rt,{class:"mx-4"})])):I("",!0),!e.value||s.isMobile?(r(),P("div",{key:4,style:{"overflow-y":"auto","flex-grow":"1"},class:Le({"fade-in":h.value})},[s.sessions.length>0?(r(),$(se,{key:0,flat:"",style:{"background-color":"transparent"}},{default:o(()=>[t(Se,{density:"compact",nav:"",class:"conversation-list",style:{"background-color":"transparent"},selected:s.selectedSessions,"onUpdate:selected":f[3]||(f[3]=m=>s.$emit("selectConversation",m))},{default:o(()=>[(r(!0),P(ae,null,ce(s.sessions,m=>(r(),$(_e,{key:m.session_id,value:m.session_id,rounded:"lg",class:"conversation-item","active-color":"secondary"},dt({default:o(()=>[!e.value||s.isMobile?(r(),$(ye,{key:0,class:"conversation-title"},{default:o(()=>[D(N(m.display_name||n(b)("conversation.newConversation")),1)]),_:2},1024)):I("",!0),!e.value||s.isMobile?(r(),$(be,{key:1,class:"timestamp"},{default:o(()=>[D(N(new Date(m.updated_at).toLocaleString()),1)]),_:2},1024)):I("",!0)]),_:2},[!e.value||s.isMobile?{name:"append",fn:o(()=>[k("div",Dt,[t(V,{icon:"mdi-pencil",size:"x-small",variant:"text",class:"edit-title-btn",onClick:Ve(L=>s.$emit("editTitle",m.session_id,m.display_name),["stop"])},null,8,["onClick"]),t(V,{icon:"mdi-delete",size:"x-small",variant:"text",class:"delete-conversation-btn",color:"error",onClick:Ve(L=>s.$emit("deleteConversation",m.session_id),["stop"])},null,8,["onClick"])])]),key:"0"}:void 0]),1032,["value"]))),128))]),_:1},8,["selected"])]),_:1})):I("",!0),t(ct,null,{default:o(()=>[s.sessions.length===0?(r(),P("div",Ut,[t(O,{icon:"mdi-message-text-outline",size:"large",color:"grey-lighten-1"}),!e.value||h.value||s.isMobile?(r(),P("div",$t,N(n(b)("conversation.noHistory")),1)):I("",!0)])):I("",!0)]),_:1})],2)):I("",!0)],38))}});const Nt=me(Vt,[["__scopeId","data-v-014bf03f"]]);const Et={name:"ProviderModelSelector",props:{initialProvider:{type:String,default:""},initialModel:{type:String,default:""}},emits:["selection-changed"],data(){return{showDialog:!1,providerConfigs:[],modelList:[],selectedProviderId:"",selectedModelName:"",tempSelectedProviderId:"",tempSelectedModelName:"",loadingModels:!1}},mounted(){this.loadFromStorage(),this.resetTempSelection(),this.loadProviderConfigs(),this.selectedProviderId&&this.getProviderModels(this.selectedProviderId)},methods:{loadFromStorage(){const i=localStorage.getItem("selectedProvider"),c=localStorage.getItem("selectedModel");i?this.selectedProviderId=i:this.initialProvider&&(this.selectedProviderId=this.initialProvider),c?this.selectedModelName=c:this.initialModel&&(this.selectedModelName=this.initialModel)},saveToStorage(){this.selectedProviderId&&localStorage.setItem("selectedProvider",this.selectedProviderId),this.selectedModelName&&localStorage.setItem("selectedModel",this.selectedModelName)},loadProviderConfigs(){F.get("/api/config/provider/list",{params:{provider_type:"chat_completion"}}).then(i=>{i.data.status==="ok"?this.providerConfigs=i.data.data||[]:console.error("获取聊天完成提供商列表失败:",i.data.message)}).catch(i=>{console.error("获取聊天完成提供商列表失败:",i)})},getProviderModels(i){this.loadingModels=!0,F.get("/api/config/provider/model_list",{params:{provider_id:i}}).then(c=>{c.data.status==="ok"?this.modelList=c.data.data.models||[]:(console.error("获取模型列表失败:",c.data.message),this.modelList=[])}).catch(c=>{console.error("获取模型列表失败:",c),this.modelList=[]}).finally(()=>{this.loadingModels=!1})},selectProvider(i){this.tempSelectedProviderId=i.id,this.tempSelectedModelName="",this.modelList=[],this.getProviderModels(i.id)},selectModel(i){this.tempSelectedModelName=i},refreshModels(){this.tempSelectedProviderId&&this.getProviderModels(this.tempSelectedProviderId)},confirmSelection(){this.tempSelectedProviderId&&this.tempSelectedModelName&&(this.selectedProviderId=this.tempSelectedProviderId,this.selectedModelName=this.tempSelectedModelName,this.saveToStorage(),this.$emit("selection-changed",{providerId:this.selectedProviderId,modelName:this.selectedModelName}),this.closeDialog())},closeDialog(){this.showDialog=!1,this.resetTempSelection()},resetTempSelection(){this.tempSelectedProviderId=this.selectedProviderId,this.tempSelectedModelName=this.selectedModelName,this.tempSelectedProviderId&&this.getProviderModels(this.tempSelectedProviderId)},openDialog(){this.resetTempSelection(),this.showDialog=!0},getCurrentSelection(){return{providerId:this.selectedProviderId,modelName:this.selectedModelName}}}},q=i=>(Ie("data-v-06593067"),i=i(),xe(),i),zt=q(()=>k("span",null,"选择提供商和模型",-1)),At={class:"provider-model-container"},Ot={class:"provider-list-panel"},Bt=q(()=>k("div",{class:"panel-header"},[k("h4",null,"提供商")],-1)),jt={key:0,class:"empty-state"},Ft=q(()=>k("div",{class:"empty-text"},"暂无可用提供商",-1)),Wt={class:"model-list-panel"},Kt={class:"panel-header"},Ht=q(()=>k("h4",null,"模型",-1)),Jt={key:1,class:"empty-state"},Gt=q(()=>k("div",{class:"empty-text"},"请先选择提供商",-1)),qt={key:2,class:"empty-state"},Qt=q(()=>k("div",{class:"empty-text"},"该提供商暂无可用模型",-1));function Xt(i,c,u,b,e,d){return r(),P("div",null,[e.selectedProviderId&&e.selectedModelName?(r(),$(ue,{key:0,class:"text-none",variant:"tonal",size:"x-small",onClick:d.openDialog},{default:o(()=>[D(N(e.selectedProviderId)+" / "+N(e.selectedModelName),1)]),_:1},8,["onClick"])):(r(),$(ue,{key:1,variant:"tonal",rounded:"xl",size:"x-small",onClick:d.openDialog},{default:o(()=>[D(" 选择模型 ")]),_:1},8,["onClick"])),t(we,{modelValue:e.showDialog,"onUpdate:modelValue":c[1]||(c[1]=l=>e.showDialog=l),"max-width":"800",persistent:""},{default:o(()=>[t(se,{style:{padding:"8px"}},{default:o(()=>[t(ke,{class:"dialog-title"},{default:o(()=>[zt]),_:1}),t(re,{class:"pa-0"},{default:o(()=>[k("div",At,[k("div",Ot,[Bt,t(Se,{density:"compact",nav:"",class:"provider-list"},{default:o(()=>[(r(!0),P(ae,null,ce(e.providerConfigs,l=>(r(),$(_e,{key:l.id,value:l.id,onClick:h=>d.selectProvider(l),active:e.tempSelectedProviderId===l.id,rounded:"lg",class:"provider-item"},{default:o(()=>[t(ye,null,{default:o(()=>[D(N(l.id),1)]),_:2},1024),l.api_base?(r(),$(be,{key:0},{default:o(()=>[D(N(l.api_base),1)]),_:2},1024)):I("",!0)]),_:2},1032,["value","onClick","active"]))),128))]),_:1}),e.providerConfigs.length===0?(r(),P("div",jt,[t(O,{icon:"mdi-cloud-off-outline",size:"large",color:"grey-lighten-1"}),Ft])):I("",!0)]),k("div",Wt,[k("div",Kt,[Ht,e.tempSelectedProviderId?(r(),$(V,{key:0,icon:"mdi-refresh",size:"small",variant:"text",onClick:d.refreshModels,loading:e.loadingModels},null,8,["onClick","loading"])):I("",!0)]),e.tempSelectedProviderId?(r(),$(Se,{key:0,density:"compact",nav:"",class:"model-list"},{default:o(()=>[t(Be,{modelValue:e.tempSelectedModelName,"onUpdate:modelValue":c[0]||(c[0]=l=>e.tempSelectedModelName=l),placeholder:"自定义模型","hide-details":"",solo:"",variant:"outlined",density:"compact",class:"mb-2 mx-2"},null,8,["modelValue"]),(r(!0),P(ae,null,ce(e.modelList,l=>(r(),$(_e,{key:l,value:l,onClick:h=>d.selectModel(l),active:e.tempSelectedModelName===l,rounded:"lg",class:"model-item"},{default:o(()=>[t(ye,null,{default:o(()=>[D(N(l),1)]),_:2},1024),l.description?(r(),$(be,{key:0},{default:o(()=>[D(N(l.description),1)]),_:2},1024)):I("",!0)]),_:2},1032,["value","onClick","active"]))),128))]),_:1})):(r(),P("div",Jt,[t(O,{icon:"mdi-robot-outline",size:"large",color:"grey-lighten-1"}),Gt])),e.tempSelectedProviderId&&e.modelList.length===0&&!e.loadingModels?(r(),P("div",qt,[t(O,{icon:"mdi-robot-off-outline",size:"large",color:"grey-lighten-1"}),Qt])):I("",!0)])])]),_:1}),t(je,null,{default:o(()=>[t(Fe),t(V,{text:"",onClick:d.closeDialog,color:"grey-darken-1"},{default:o(()=>[D("取消")]),_:1},8,["onClick"]),t(V,{text:"",onClick:d.confirmSelection,color:"primary",disabled:!e.tempSelectedProviderId||!e.tempSelectedModelName},{default:o(()=>[D(" 确认选择 ")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const Yt=me(Et,[["render",Xt],["__scopeId","data-v-06593067"]]),Zt={class:"input-area fade-in"},es={class:"input-container",style:{width:"85%","max-width":"900px",margin:"0 auto",border:"1px solid #e0e0e0","border-radius":"24px"}},ts=["disabled"],ss={style:{display:"flex","justify-content":"space-between","align-items":"center",padding:"0px 12px"}},as={style:{display:"flex","justify-content":"flex-start","margin-top":"4px","align-items":"center",gap:"8px"}},os={style:{display:"flex","justify-content":"flex-end","margin-top":"8px","align-items":"center"}},is={key:0,class:"attachments-preview"},ls=["src"],ns={key:0,class:"audio-preview"},rs=300,ds=Ce({__name:"ChatInput",props:{prompt:{},stagedImagesUrl:{},stagedAudioUrl:{},disabled:{type:Boolean},enableStreaming:{type:Boolean},isRecording:{type:Boolean}},emits:["update:prompt","send","toggleStreaming","removeImage","removeAudio","startRecording","stopRecording","pasteImage","fileSelect"],setup(i,{expose:c,emit:u}){const b=i,{tm:e}=Me("features/chat"),d=g(null),l=g(null),h=g(null),M=ve({get:()=>b.prompt,set:a=>u("update:prompt",a)}),T=ve(()=>b.prompt&&b.prompt.trim()||b.stagedImagesUrl.length>0||b.stagedAudioUrl),U=g(!1),v=g(null);function s(a){if(a.keyCode===13&&!a.shiftKey&&(a.preventDefault(),T.value&&u("send")),a.ctrlKey&&a.keyCode===66){if(a.preventDefault(),U.value)return;U.value=!0,v.value=window.setTimeout(()=>{U.value&&!b.isRecording&&u("startRecording")},rs)}}function f(a){a.keyCode===66&&(U.value=!1,v.value&&(clearTimeout(v.value),v.value=null),b.isRecording&&u("stopRecording"))}function m(a){u("pasteImage",a)}function L(){var a;(a=l.value)==null||a.click()}function E(a){const R=a.target,_=R.files;_&&u("fileSelect",_),R.value=""}function C(){b.isRecording?u("stopRecording"):u("startRecording")}function S(){var a;return(a=h.value)==null?void 0:a.getCurrentSelection()}return We(()=>{d.value&&d.value.addEventListener("paste",m),document.addEventListener("keyup",f)}),Ke(()=>{d.value&&d.value.removeEventListener("paste",m),document.removeEventListener("keyup",f)}),c({getCurrentSelection:S}),(a,R)=>(r(),P("div",Zt,[k("div",es,[vt(k("textarea",{ref_key:"inputField",ref:d,"onUpdate:modelValue":R[0]||(R[0]=_=>M.value=_),onKeydown:s,disabled:a.disabled,placeholder:"Ask AstrBot...",style:{width:"100%",resize:"none",outline:"none",border:"1px solid var(--v-theme-border)","border-radius":"12px",padding:"8px 16px","min-height":"40px","font-family":"inherit","font-size":"16px","background-color":"var(--v-theme-surface)"}},null,40,ts),[[mt,M.value]]),k("div",ss,[k("div",as,[t(Yt,{ref_key:"providerModelSelectorRef",ref:h},null,512),t(te,{text:a.enableStreaming?n(e)("streaming.enabled"):n(e)("streaming.disabled"),location:"top"},{activator:o(({props:_})=>[t(ue,de(_,{onClick:R[1]||(R[1]=z=>a.$emit("toggleStreaming")),size:"x-small",class:"streaming-toggle-chip"}),{default:o(()=>[t(O,{start:"",icon:a.enableStreaming?"mdi-flash":"mdi-flash-off",size:"small"},null,8,["icon"]),D(" "+N(a.enableStreaming?n(e)("streaming.on"):n(e)("streaming.off")),1)]),_:2},1040)]),_:1},8,["text"])]),k("div",os,[k("input",{type:"file",ref_key:"imageInputRef",ref:l,onChange:E,accept:"image/*",style:{display:"none"},multiple:""},null,544),a.disabled?(r(),$(pt,{key:0,indeterminate:"",size:"16",class:"mr-1",width:"1.5"})):I("",!0),t(V,{onClick:L,icon:"mdi-plus",variant:"text",color:"deep-purple",class:"add-btn",size:"small"}),t(V,{onClick:C,icon:a.isRecording?"mdi-stop-circle":"mdi-microphone",variant:"text",color:a.isRecording?"error":"deep-purple",class:"record-btn",size:"small"},null,8,["icon","color"]),t(V,{onClick:R[2]||(R[2]=_=>a.$emit("send")),icon:"mdi-send",variant:"text",color:"deep-purple",disabled:!T.value,class:"send-btn",size:"small"},null,8,["disabled"])])])]),a.stagedImagesUrl.length>0||a.stagedAudioUrl?(r(),P("div",is,[(r(!0),P(ae,null,ce(a.stagedImagesUrl,(_,z)=>(r(),P("div",{key:z,class:"image-preview"},[k("img",{src:_,class:"preview-image"},null,8,ls),t(V,{onClick:A=>a.$emit("removeImage",z),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])]))),128)),a.stagedAudioUrl?(r(),P("div",ns,[t(ue,{color:"deep-purple-lighten-4",class:"audio-chip"},{default:o(()=>[t(O,{start:"",icon:"mdi-microphone",size:"small"}),D(" "+N(n(e)("voice.recording")),1)]),_:1}),t(V,{onClick:R[3]||(R[3]=_=>a.$emit("removeAudio")),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"})])):I("",!0)])):I("",!0)]))}});const cs=me(ds,[["__scopeId","data-v-f0b9872a"]]);function us(i=!1){const c=He(),u=g([]),b=g([]),e=g(""),d=g(null),l=g(!1),h=g(""),M=g(""),T=ve(()=>e.value?u.value.find(C=>C.session_id===e.value):null);async function U(){var C;try{const S=await F.get("/api/chat/sessions");if(u.value=S.data.data,d.value)u.value.find(R=>R.session_id===d.value)&&(b.value=[d.value],d.value=null);else if(!e.value&&u.value.length>0){const a=u.value[0];b.value=[a.session_id]}}catch(S){((C=S.response)==null?void 0:C.status)===401&&c.push("/auth/login?redirect=/chatbox"),console.error(S)}}async function v(){try{const S=(await F.get("/api/chat/new_session")).data.data.session_id;e.value=S;const a=i?"/chatbox":"/chat";return c.push(`${a}/${S}`),await U(),S}catch(C){throw console.error(C),C}}async function s(C){try{await F.get("/api/chat/delete_session?session_id="+C),await U(),e.value="",b.value=[]}catch(S){console.error(S)}}function f(C,S){M.value=C,h.value=S||"",l.value=!0}async function m(){if(!M.value)return;const C=h.value.trim();try{await F.post("/api/chat/update_session_display_name",{session_id:M.value,display_name:C});const S=u.value.find(a=>a.session_id===M.value);S&&(S.display_name=C),l.value=!1}catch(S){console.error("重命名会话失败:",S)}}function L(C,S){const a=u.value.find(R=>R.session_id===C);a&&(a.display_name=S)}function E(C){e.value="",b.value=[];const S=i?"/chatbox":"/chat";c.push(S),C&&C()}return{sessions:u,selectedSessions:b,currSessionId:e,pendingSessionId:d,editTitleDialog:l,editingTitle:h,editingSessionId:M,getCurrentSession:T,getSessions:U,newSession:v,deleteSession:s,showEditTitleDialog:f,saveTitle:m,updateSessionTitle:L,newChat:E}}function vs(i,c,u,b){const e=g([]),d=g(!1),l=g(!1),h=g(!1),M=g(0),T=g(!0),U=localStorage.getItem("enableStreaming");U!==null&&(T.value=JSON.parse(U));function v(){T.value=!T.value,localStorage.setItem("enableStreaming",JSON.stringify(T.value))}async function s(m,L){var E,C;if(m)try{const S=await F.get("/api/chat/get_session?session_id="+m);l.value=S.data.data.is_running||!1;let a=S.data.data.history;l.value&&(h.value||(kt().info("该会话正在运行中。",{timeout:5e3}),h.value=!0),setTimeout(()=>{s(i.value,L)},3e3));for(let R=0;R<a.length;R++){let _=a[R].content;if((E=_.message)!=null&&E.startsWith("[IMAGE]")){let z=_.message.replace("[IMAGE]","");const A=await c(z);_.embedded_images||(_.embedded_images=[]),_.embedded_images.push(A),_.message=""}if((C=_.message)!=null&&C.startsWith("[RECORD]")){let z=_.message.replace("[RECORD]","");const A=await c(z);_.embedded_audio=A,_.message=""}if(_.image_url&&_.image_url.length>0)for(let z=0;z<_.image_url.length;z++)_.image_url[z]=await c(_.image_url[z]);_.audio_url&&(_.audio_url=await c(_.audio_url))}e.value=a}catch(S){console.error(S)}}async function f(m,L,E,C,S){var _,z;const a={type:"user",message:m,image_url:[],audio_url:void 0};if(L.length>0){const A=L.map(B=>B.startsWith("blob:")?Promise.resolve(B):c(B));a.image_url=await Promise.all(A)}E&&(E.startsWith("blob:")?a.audio_url=E:a.audio_url=await c(E)),e.value.push({content:a});const R=Ne({type:"bot",message:"",reasoning:"",isLoading:!0});e.value.push({content:R});try{M.value++,M.value===1&&(l.value=!0);const A=await fetch("/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:m,session_id:i.value,image_url:L,audio_url:E?[E]:[],selected_provider:C,selected_model:S,enable_streaming:T.value})});if(!A.ok)throw new Error(`HTTP error! status: ${A.status}`);const B=A.body.getReader(),pe=new TextDecoder;let G=!1,K=null;for(d.value=!0;;)try{const{done:H,value:ge}=await B.read();if(H){console.log("SSE stream completed");break}const oe=pe.decode(ge,{stream:!0}).split(`

`);for(let Q=0;Q<oe.length;Q++){let X=oe[Q].trim();if(!X)continue;let x;try{x=JSON.parse(X.replace("data: ",""))}catch(j){console.warn("JSON解析失败:",X,j);continue}if(!x||typeof x!="object"||!x.hasOwnProperty("type")){console.warn("无效的数据对象:",x);continue}if(x.type==="error"){console.error("Error received:",x.data);continue}if(x.type==="image"){let j=x.data.replace("[IMAGE]",""),Y={type:"bot",message:"",embedded_images:[await c(j)]};e.value.push({content:Y})}else if(x.type==="record"){let j=x.data.replace("[RECORD]",""),Y={type:"bot",message:"",embedded_audio:await c(j)};e.value.push({content:Y})}else if(x.type==="plain"){const j=x.chain_type||"normal";if(G)j==="reasoning"?K.reasoning=(K.reasoning||"")+x.data:K.message=(K.message||"")+x.data;else{const J=e.value[e.value.length-1];(_=J==null?void 0:J.content)!=null&&_.isLoading&&e.value.pop(),K=Ne({type:"bot",message:j==="reasoning"?"":x.data,reasoning:j==="reasoning"?x.data:""}),e.value.push({content:K}),G=!0}}else x.type==="update_title"&&u(x.session_id,x.data);(x.type==="break"&&x.streaming||!x.streaming)&&(G=!1,x.streaming||(d.value=!1))}}catch(H){console.error("SSE读取错误:",H);break}b()}catch(A){console.error("发送消息失败:",A);const B=e.value[e.value.length-1];(z=B==null?void 0:B.content)!=null&&z.isLoading&&e.value.pop()}finally{d.value=!1,M.value--,M.value===0&&(l.value=!1)}}return{messages:e,isStreaming:d,isConvRunning:l,enableStreaming:T,getSessionMessages:s,sendMessage:f,toggleStreaming:v}}function ms(){const i=g([]),c=g([]),u=g(""),b=g({});async function e(v){if(b.value[v])return b.value[v];try{const s=await F.get("/api/chat/get_file",{params:{filename:v},responseType:"blob"}),f=URL.createObjectURL(s.data);return b.value[v]=f,f}catch(s){return console.error("Error fetching media file:",s),""}}async function d(v){const s=new FormData;s.append("file",v);try{const m=(await F.post("/api/chat/post_image",s,{headers:{"Content-Type":"multipart/form-data"}})).data.data.filename;i.value.push(m),c.value.push(URL.createObjectURL(v))}catch(f){console.error("Error uploading image:",f)}}async function l(v){var f;const s=(f=v.clipboardData)==null?void 0:f.items;if(s){for(let m=0;m<s.length;m++)if(s[m].type.indexOf("image")!==-1){const L=s[m].getAsFile();L&&await d(L)}}}function h(v){const s=c.value[v];s&&s.startsWith("blob:")&&URL.revokeObjectURL(s),i.value.splice(v,1),c.value.splice(v,1)}function M(){u.value=""}function T(){i.value=[],c.value=[],u.value=""}function U(){Object.values(b.value).forEach(v=>{v.startsWith("blob:")&&URL.revokeObjectURL(v)}),b.value={}}return{stagedImagesName:i,stagedImagesUrl:c,stagedAudioUrl:u,getMediaFile:e,processAndUploadImage:d,handlePaste:l,removeImage:h,removeAudio:M,clearStaged:T,cleanupMediaCache:U}}function ps(){const i=g(!1),c=g([]),u=g(null);async function b(d){try{const l=await navigator.mediaDevices.getUserMedia({audio:!0});u.value=new MediaRecorder(l),u.value.ondataavailable=h=>{c.value.push(h.data)},u.value.start(),i.value=!0,d&&d("录音中...")}catch(l){console.error("Failed to start recording:",l)}}async function e(d){return new Promise((l,h)=>{if(!u.value){h("No media recorder");return}i.value=!1,d&&d("聊天输入框"),u.value.stop(),u.value.onstop=async()=>{var U;const M=new Blob(c.value,{type:"audio/wav"});c.value=[],(U=u.value)==null||U.stream.getTracks().forEach(v=>v.stop());const T=new FormData;T.append("file",M);try{const s=(await F.post("/api/chat/post_file",T,{headers:{"Content-Type":"multipart/form-data"}})).data.data.filename;console.log("Audio uploaded:",s),l(s)}catch(v){console.error("Error uploading audio:",v),h(v)}}})}return{isRecording:i,startRecording:b,stopRecording:e}}const gs=i=>(Ie("data-v-d2adfa2c"),i=i(),xe(),i),fs={class:"chat-layout"},hs={class:"chat-content-panel"},_s={class:"conversation-header fade-in"},ys={class:"conversation-header-actions"},bs={key:1,class:"welcome-container fade-in"},Ss=gs(()=>k("div",{class:"welcome-title"},[k("span",null,"Hello, I'm"),k("span",{class:"bot-name"},"AstrBot ⭐")],-1)),ks=[Ss],ws=["src"],Cs=Ce({__name:"Chat",props:{chatboxMode:{type:Boolean,default:!1}},setup(i){const c=i,u=He(),b=gt(),{t:e}=Oe(),{tm:d}=Me("features/chat"),l=ft(),h=g(!1),M=g(!1),T=g(!1),U=g(""),{sessions:v,selectedSessions:s,currSessionId:f,pendingSessionId:m,editTitleDialog:L,editingTitle:E,editingSessionId:C,getCurrentSession:S,getSessions:a,newSession:R,deleteSession:_,showEditTitleDialog:z,saveTitle:A,updateSessionTitle:B,newChat:pe}=us(c.chatboxMode),{stagedImagesName:G,stagedImagesUrl:K,stagedAudioUrl:H,getMediaFile:ge,processAndUploadImage:Pe,handlePaste:oe,removeImage:Q,removeAudio:X,clearStaged:x,cleanupMediaCache:j}=ms(),{isRecording:J,startRecording:Y,stopRecording:Je}=ps(),{messages:Z,isStreaming:Te,isConvRunning:Re,enableStreaming:Ge,getSessionMessages:qe,sendMessage:Qe,toggleStreaming:Xe}=vs(f,ge,B,a),De=g(null),Ue=g(null),ee=g(""),ie=ve(()=>Ae().uiTheme==="PurpleThemeDark");function fe(){h.value=window.innerWidth<=768,h.value||(M.value=!1)}function Ye(){M.value=!M.value}function le(){M.value=!1}function Ze(){const p=Ae(),y=p.uiTheme==="PurpleTheme"?"PurpleThemeDark":"PurpleTheme";p.SET_UI_THEME(y),l.global.name.value=y}function et(p){U.value=p,T.value=!0}async function ne(p){if(!p[0])return;const y=c.chatboxMode?"/chatbox":"/chat";if(b.path!==`${y}/${p[0]}`){u.push(`${y}/${p[0]}`);return}h.value&&le(),f.value=p[0],s.value=[p[0]],await qe(p[0],u),_t(()=>{var w;(w=De.value)==null||w.scrollToBottom()})}function tt(){pe(le),Z.value=[]}async function st(p){await _(p),Z.value=[]}async function at(){await Y()}async function ot(){const p=await Je();H.value=p}async function it(p){for(const y of p)await Pe(y)}async function lt(){var $e;if(!ee.value.trim()&&G.value.length===0&&!H.value)return;f.value||await R();const p=ee.value.trim(),y=[...G.value],w=H.value;ee.value="",x();const W=($e=Ue.value)==null?void 0:$e.getCurrentSelection(),he=(W==null?void 0:W.providerId)||"",nt=(W==null?void 0:W.modelName)||"";await Qe(p,y,w,he,nt)}return Ee(()=>b.path,(p,y)=>{if(!(y&&(y.startsWith("/chat")&&p.startsWith("/chatbox")||y.startsWith("/chatbox")&&p.startsWith("/chat")))&&(p.startsWith("/chat/")||p.startsWith("/chatbox/"))){const w=p.split("/")[2];w&&w!==f.value&&(v.value.length>0?v.value.find(he=>he.session_id===w)&&ne([w]):m.value=w)}},{immediate:!0}),Ee(v,p=>{if(m.value&&p.length>0)p.find(w=>w.session_id===m.value)&&(s.value=[m.value],ne([m.value]),m.value=null);else if(!f.value&&p.length>0){const y=p[0];s.value=[y.session_id],ne([y.session_id])}}),We(()=>{fe(),window.addEventListener("resize",fe),a()}),Ke(()=>{window.removeEventListener("resize",fe),j()}),(p,y)=>(r(),P(ae,null,[t(se,{class:"chat-page-card",elevation:"0",rounded:"0"},{default:o(()=>[t(re,{class:"chat-page-container"},{default:o(()=>[h.value&&M.value?(r(),P("div",{key:0,class:"mobile-overlay",onClick:le})):I("",!0),k("div",fs,[t(Nt,{sessions:n(v),selectedSessions:n(s),currSessionId:n(f),isDark:ie.value,chatboxMode:p.chatboxMode,isMobile:h.value,mobileMenuOpen:M.value,onNewChat:tt,onSelectConversation:ne,onEditTitle:n(z),onDeleteConversation:st,onCloseMobileSidebar:le},null,8,["sessions","selectedSessions","currSessionId","isDark","chatboxMode","isMobile","mobileMenuOpen","onEditTitle"]),k("div",hs,[k("div",_s,[h.value?(r(),$(V,{key:0,icon:"",class:"mobile-menu-btn",onClick:Ye,variant:"text"},{default:o(()=>[t(O,null,{default:o(()=>[D("mdi-menu")]),_:1})]),_:1})):I("",!0),k("div",ys,[p.chatboxMode?I("",!0):(r(),$(te,{key:0,text:n(d)("actions.fullscreen")},{activator:o(({props:w})=>[t(O,de(w,{onClick:y[0]||(y[0]=W=>n(u).push(n(f)?`/chatbox/${n(f)}`:"/chatbox")),class:"fullscreen-icon"}),{default:o(()=>[D("mdi-fullscreen")]),_:2},1040)]),_:1},8,["text"])),p.chatboxMode?(r(),$(te,{key:1,text:n(e)("core.common.language")},{activator:o(({props:w})=>[t(yt,{variant:"chatbox"})]),_:1},8,["text"])):I("",!0),p.chatboxMode?(r(),$(te,{key:2,text:ie.value?n(d)("modes.lightMode"):n(d)("modes.darkMode")},{activator:o(({props:w})=>[t(V,de(w,{icon:"",onClick:Ze,class:"theme-toggle-icon",size:"small",rounded:"sm",style:{"margin-right":"8px"},variant:"text"}),{default:o(()=>[t(O,null,{default:o(()=>[D(N(ie.value?"mdi-weather-night":"mdi-white-balance-sunny"),1)]),_:1})]),_:2},1040)]),_:1},8,["text"])):I("",!0),p.chatboxMode?(r(),$(te,{key:3,text:n(d)("actions.exitFullscreen")},{activator:o(({props:w})=>[t(O,de(w,{onClick:y[1]||(y[1]=W=>n(u).push(n(f)?`/chat/${n(f)}`:"/chat")),class:"fullscreen-icon"}),{default:o(()=>[D("mdi-fullscreen-exit")]),_:2},1040)]),_:1},8,["text"])):I("",!0)])]),n(Z)&&n(Z).length>0?(r(),$(bt,{key:0,messages:n(Z),isDark:ie.value,isStreaming:n(Te)||n(Re),onOpenImagePreview:et,ref_key:"messageList",ref:De},null,8,["messages","isDark","isStreaming"])):(r(),P("div",bs,ks)),t(cs,{prompt:ee.value,"onUpdate:prompt":y[2]||(y[2]=w=>ee.value=w),stagedImagesUrl:n(K),stagedAudioUrl:n(H),disabled:n(Te)||n(Re),enableStreaming:n(Ge),isRecording:n(J),onSend:lt,onToggleStreaming:n(Xe),onRemoveImage:n(Q),onRemoveAudio:n(X),onStartRecording:at,onStopRecording:ot,onPasteImage:n(oe),onFileSelect:it,ref_key:"chatInputRef",ref:Ue},null,8,["prompt","stagedImagesUrl","stagedAudioUrl","disabled","enableStreaming","isRecording","onToggleStreaming","onRemoveImage","onRemoveAudio","onPasteImage"])])])]),_:1})]),_:1}),t(we,{modelValue:n(L),"onUpdate:modelValue":y[5]||(y[5]=w=>ze(L)?L.value=w:null),"max-width":"400"},{default:o(()=>[t(se,null,{default:o(()=>[t(ke,{class:"dialog-title"},{default:o(()=>[D(N(n(d)("actions.editTitle")),1)]),_:1}),t(re,null,{default:o(()=>[t(Be,{modelValue:n(E),"onUpdate:modelValue":y[3]||(y[3]=w=>ze(E)?E.value=w:null),label:n(d)("conversation.newConversation"),variant:"outlined","hide-details":"",class:"mt-2",onKeyup:ht(n(A),["enter"]),autofocus:""},null,8,["modelValue","label","onKeyup"])]),_:1}),t(je,null,{default:o(()=>[t(Fe),t(V,{variant:"text",onClick:y[4]||(y[4]=w=>L.value=!1),color:"grey-darken-1"},{default:o(()=>[D(N(n(e)("core.common.cancel")),1)]),_:1}),t(V,{variant:"text",onClick:n(A),color:"primary"},{default:o(()=>[D(N(n(e)("core.common.save")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(we,{modelValue:T.value,"onUpdate:modelValue":y[7]||(y[7]=w=>T.value=w),"max-width":"90vw","max-height":"90vh"},{default:o(()=>[t(se,{class:"image-preview-card",elevation:"8"},{default:o(()=>[t(ke,{class:"d-flex justify-space-between align-center pa-4"},{default:o(()=>[k("span",null,N(n(e)("core.common.imagePreview")),1),t(V,{icon:"mdi-close",variant:"text",onClick:y[6]||(y[6]=w=>T.value=!1)})]),_:1}),t(re,{class:"text-center pa-4"},{default:o(()=>[k("img",{src:U.value,class:"preview-image-large"},null,8,ws)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});const Us=me(Cs,[["__scopeId","data-v-d2adfa2c"]]);export{Us as C};
