import{b7 as S,a5 as _}from"./index-77b120c5.js";const T=S({id:"common",state:()=>({eventSource:null,log_cache:[],sse_connected:!1,log_cache_max_len:1e3,startTime:-1,pluginMarketData:[]}),actions:{async createEventSource(){if(await(async()=>{try{const e=await _.get("/api/log-history");e.data.data.logs?this.log_cache.push(...e.data.data.logs):this.log_cache=[]}catch(e){console.error("Failed to fetch log history:",e)}})(),this.eventSource)return;const g=new AbortController,{signal:t}=g,c={"Content-Type":"multipart/form-data",Authorization:"Bearer "+localStorage.getItem("token")};fetch("/api/live-log",{method:"GET",headers:c,signal:t,cache:"no-cache"}).then(e=>{if(!e.ok)throw new Error(`SSE connection failed: ${e.status}`);console.log("SSE stream opened"),this.sse_connected=!0;const l=e.body.getReader(),u=new TextDecoder;let s="";const d=r=>{s+=r;try{const o=JSON.parse(s);return s="",o}catch{return null}},h=({done:r,value:o})=>{const a=o?o.byteLength:0;if(console.log(`Received ${a} bytes from live log`),r){console.log("SSE stream closed"),setTimeout(()=>{this.eventSource=null,this.createEventSource()},2e3);return}return u.decode(o).split(`

`).forEach(p=>{if(p.trim())if(p.startsWith("data:")){const n=p.substring(5).trim();let m={};try{m=JSON.parse(n)}catch{console.warn("Invalid JSON:",n);const f=d(n);if(f)m=f;else return}m.type==="log"&&(this.log_cache.push(m),this.log_cache.length>this.log_cache_max_len&&this.log_cache.shift())}else{const n=d(p);n&&n.type==="log"&&(this.log_cache.push(n),this.log_cache.length>this.log_cache_max_len&&this.log_cache.shift())}}),l.read().then(h)};l.read().then(h)}).catch(e=>{console.error("SSE error:",e),this.log_cache.push("SSE Connection failed, retrying in 5 seconds..."),setTimeout(()=>{this.eventSource=null,this.createEventSource()},1e3)}),this.eventSource=g},closeEventSourcet(){this.eventSource&&(this.eventSource.abort(),this.eventSource=null)},getLogCache(){return this.log_cache},getStartTime(){if(this.startTime!==-1)return this.startTime;_.get("/api/stat/start-time").then(i=>{this.startTime=i.data.data.start_time})},async getPluginCollections(i=!1){if(!i&&this.pluginMarketData.length>0)return Promise.resolve(this.pluginMarketData);const g=i?"/api/plugin/market_list?force_refresh=true":"/api/plugin/market_list";return _.get(g).then(t=>{var e,l,u,s,d,h,r,o;let c=[];for(let a in t.data.data)c.push({name:a,desc:t.data.data[a].desc,author:t.data.data[a].author,repo:t.data.data[a].repo,installed:!1,version:(e=t.data.data[a])!=null&&e.version?t.data.data[a].version:"未知",social_link:(l=t.data.data[a])==null?void 0:l.social_link,tags:(u=t.data.data[a])!=null&&u.tags?t.data.data[a].tags:[],logo:(s=t.data.data[a])!=null&&s.logo?t.data.data[a].logo:"",pinned:(d=t.data.data[a])!=null&&d.pinned?t.data.data[a].pinned:!1,stars:(h=t.data.data[a])!=null&&h.stars?t.data.data[a].stars:0,updated_at:(r=t.data.data[a])!=null&&r.updated_at?t.data.data[a].updated_at:"",display_name:(o=t.data.data[a])!=null&&o.display_name?t.data.data[a].display_name:""});return this.pluginMarketData=c,c}).catch(t=>Promise.reject(t))}}});export{T as u};
