import{ac as D,a5 as F,r as M,o as m,a as f,w as a,b as i,N as R,e as d,t as n,P as E,a3 as L,$ as T,aN as k,aE as z,aF as S,aG as P,l as _,k as y,p as g,aH as C,A as h,ag as I,ah as w,g as u,F as b,h as V,a_ as U,V as B,a$ as q,E as H,d as O,q as W,ai as G,C as v,a1 as j,L as Q,M as J,a2 as K}from"./index-77b120c5.js";import{_ as X}from"./_plugin-vue_export-helper-c27b6911.js";const Y={name:"PersonaForm",props:{modelValue:{type:Boolean,default:!1},editingPersona:{type:Object,default:null}},emits:["update:modelValue","saved","error"],setup(){const{tm:e}=D("features/persona");return{tm:e}},data(){return{toolSelectValue:"0",saving:!1,expandedPanels:[],formValid:!1,mcpServers:[],availableTools:[],loadingTools:!1,personaForm:{persona_id:"",system_prompt:"",begin_dialogs:[],tools:[]},personaIdRules:[e=>!!e||this.tm("validation.required"),e=>e&&e.length>=0||this.tm("validation.minLength",{min:2})],systemPromptRules:[e=>!!e||this.tm("validation.required"),e=>e&&e.length>=10||this.tm("validation.minLength",{min:10})],toolSearch:""}},computed:{showDialog:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},filteredTools(){if(!this.toolSearch)return this.availableTools;const e=this.toolSearch.toLowerCase();return this.availableTools.filter(s=>s.name.toLowerCase().includes(e)||s.description&&s.description.toLowerCase().includes(e)||s.mcp_server_name&&s.mcp_server_name.toLowerCase().includes(e))}},watch:{modelValue(e){e&&(this.editingPersona?this.initFormWithPersona(this.editingPersona):this.initForm(),this.loadMcpServers(),this.loadTools())},editingPersona:{immediate:!0,handler(e){this.modelValue&&(e?this.initFormWithPersona(e):this.initForm())}},toolSelectValue(e){e==="0"?this.personaForm.tools=null:e==="1"&&this.personaForm.tools===null&&(this.personaForm.tools=[])}},methods:{initForm(){this.personaForm={persona_id:"",system_prompt:"",begin_dialogs:[],tools:[]},this.toolSelectValue="0",this.expandedPanels=[]},initFormWithPersona(e){this.personaForm={persona_id:e.persona_id,system_prompt:e.system_prompt,begin_dialogs:[...e.begin_dialogs||[]],tools:e.tools===null?null:[...e.tools||[]]},this.toolSelectValue=e.tools===null?"0":"1",this.expandedPanels=[]},closeDialog(){this.showDialog=!1},async loadMcpServers(){var e,s;try{const r=await F.get("/api/tools/mcp/servers");r.data.status==="ok"?this.mcpServers=r.data.data||[]:this.$emit("error",r.data.message||"Failed to load MCP servers")}catch(r){this.$emit("error",((s=(e=r.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to load MCP servers"),this.mcpServers=[]}},async loadTools(){var e,s;this.loadingTools=!0;try{const r=await F.get("/api/tools/list");r.data.status==="ok"?this.availableTools=r.data.data||[]:this.$emit("error",r.data.message||"Failed to load tools")}catch(r){this.$emit("error",((s=(e=r.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to load tools"),this.availableTools=[]}finally{this.loadingTools=!1}},async savePersona(){var e,s;if(this.formValid){if(this.personaForm.begin_dialogs.length>0){for(let r=0;r<this.personaForm.begin_dialogs.length;r++)if(!this.personaForm.begin_dialogs[r]||this.personaForm.begin_dialogs[r].trim()===""){const o=r%2===0?this.tm("form.userMessage"):this.tm("form.assistantMessage");this.$emit("error",this.tm("validation.dialogRequired",{type:o}));return}}this.saving=!0;try{const r=this.editingPersona?"/api/persona/update":"/api/persona/create",o=await F.post(r,this.personaForm);o.data.status==="ok"?(this.$emit("saved",o.data.message||this.tm("messages.saveSuccess")),this.closeDialog()):this.$emit("error",o.data.message||this.tm("messages.saveError"))}catch(r){this.$emit("error",((s=(e=r.response)==null?void 0:e.data)==null?void 0:s.message)||this.tm("messages.saveError"))}this.saving=!1}},addDialogPair(){this.personaForm.begin_dialogs.push("",""),this.expandedPanels.includes("dialogs")||this.expandedPanels.push("dialogs")},removeDialog(e){e%2===0&&e+1<this.personaForm.begin_dialogs.length?this.personaForm.begin_dialogs.splice(e,2):e%2===1&&e-1>=0&&this.personaForm.begin_dialogs.splice(e-1,2)},toggleMcpServer(e){if(!e.tools||e.tools.length===0)return;if(this.personaForm.tools===null){this.personaForm.tools=this.availableTools.map(o=>o.name).filter(o=>!e.tools.includes(o)),this.toolSelectValue="1";return}Array.isArray(this.personaForm.tools)||(this.personaForm.tools=[],this.toolSelectValue="1");const s=e.tools;s.every(o=>this.personaForm.tools.includes(o))?this.personaForm.tools=this.personaForm.tools.filter(o=>!s.includes(o)):s.forEach(o=>{this.personaForm.tools.includes(o)||this.personaForm.tools.push(o)})},toggleTool(e){if(this.personaForm.tools===null)this.personaForm.tools=this.availableTools.map(s=>s.name).filter(s=>s!==e),this.toolSelectValue="1";else if(Array.isArray(this.personaForm.tools)){const s=this.personaForm.tools.indexOf(e);s!==-1?this.personaForm.tools.splice(s,1):this.personaForm.tools.push(e)}else this.personaForm.tools=[e],this.toolSelectValue="1"},removeTool(e){if(this.personaForm.tools===null)this.personaForm.tools=this.availableTools.map(s=>s.name).filter(s=>s!==e),this.toolSelectValue="1";else if(Array.isArray(this.personaForm.tools)){const s=this.personaForm.tools.indexOf(e);s!==-1&&this.personaForm.tools.splice(s,1)}},truncateText(e,s){return e?e.length>s?e.substring(0,s)+"...":e:""},getDialogRules(e){const s=e%2===0?this.tm("form.userMessage"):this.tm("form.assistantMessage");return[r=>!!r||this.tm("validation.dialogRequired",{type:s}),r=>r&&r.trim().length>0||this.tm("validation.dialogRequired",{type:s})]},isToolSelected(e){return this.personaForm.tools===null?!0:Array.isArray(this.personaForm.tools)&&this.personaForm.tools.includes(e)},isServerSelected(e){return!e.tools||e.tools.length===0?!1:this.personaForm.tools===null?!0:Array.isArray(this.personaForm.tools)&&e.tools.every(s=>this.personaForm.tools.includes(s))}}},Z={class:"mb-3"},N={class:"text-body-2 text-medium-emphasis"},$={key:0,class:"mt-3 ml-8"},ee={key:0,class:"mb-4"},se={class:"text-subtitle-2 mb-2"},oe={class:"d-flex flex-wrap ga-2"},le={key:1,class:"tools-selection"},te={key:2,class:"text-center pa-4"},ae={class:"text-body-2 text-medium-emphasis"},ie={key:3,class:"text-center pa-4"},re={class:"text-body-2 text-medium-emphasis"},ne={key:4,class:"text-center pa-4"},me={class:"text-body-2 text-medium-emphasis mt-2"},de={class:"mt-4"},ce={class:"text-subtitle-2 mb-2"},ue={key:0,class:"text-success"},he={key:1},pe={key:0,class:"d-flex flex-wrap ga-1",style:{"max-height":"100px","overflow-y":"auto"}},ge={key:1,class:"text-body-2 text-medium-emphasis"},fe={class:"mb-3"},_e={class:"text-body-2 text-medium-emphasis"};function ye(e,s,r,o,t,c){const A=M("v-chip-text");return m(),f(K,{modelValue:c.showDialog,"onUpdate:modelValue":s[6]||(s[6]=l=>c.showDialog=l),"max-width":"500px",persistent:""},{default:a(()=>[i(J,null,{default:a(()=>[i(R,{class:"text-h2"},{default:a(()=>[d(n(r.editingPersona?o.tm("dialog.edit.title"):o.tm("dialog.create.title")),1)]),_:1}),i(E,null,{default:a(()=>[i(L,{ref:"personaForm",modelValue:t.formValid,"onUpdate:modelValue":s[5]||(s[5]=l=>t.formValid=l)},{default:a(()=>[i(T,{modelValue:t.personaForm.persona_id,"onUpdate:modelValue":s[0]||(s[0]=l=>t.personaForm.persona_id=l),label:o.tm("form.personaId"),rules:t.personaIdRules,disabled:r.editingPersona,variant:"outlined",density:"comfortable",class:"mb-4"},null,8,["modelValue","label","rules","disabled"]),i(k,{modelValue:t.personaForm.system_prompt,"onUpdate:modelValue":s[1]||(s[1]=l=>t.personaForm.system_prompt=l),label:o.tm("form.systemPrompt"),rules:t.systemPromptRules,variant:"outlined",rows:"6",class:"mb-4"},null,8,["modelValue","label","rules"]),i(z,{modelValue:t.expandedPanels,"onUpdate:modelValue":s[4]||(s[4]=l=>t.expandedPanels=l),multiple:""},{default:a(()=>[i(S,{value:"tools"},{default:a(()=>[i(P,null,{default:a(()=>[i(_,{class:"mr-2"},{default:a(()=>[d("mdi-tools")]),_:1}),d(" "+n(o.tm("form.tools"))+" ",1),Array.isArray(t.personaForm.tools)&&t.personaForm.tools.length>0?(m(),f(y,{key:0,size:"small",color:"primary",variant:"tonal",class:"ml-2"},{default:a(()=>[d(n(t.personaForm.tools.length),1)]),_:1})):g("",!0)]),_:1}),i(C,null,{default:a(()=>[h("div",Z,[h("p",N,n(o.tm("form.toolsHelp")),1)]),i(I,{class:"mt-2",modelValue:t.toolSelectValue,"onUpdate:modelValue":s[2]||(s[2]=l=>t.toolSelectValue=l),"hide-details":"true"},{default:a(()=>[i(w,{label:"默认使用全部函数工具",value:"0"}),i(w,{label:"选择指定函数工具",value:"1"})]),_:1},8,["modelValue"]),t.toolSelectValue==="1"?(m(),u("div",$,[i(T,{modelValue:t.toolSearch,"onUpdate:modelValue":s[3]||(s[3]=l=>t.toolSearch=l),label:o.tm("form.searchTools"),"prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact","hide-details":"",clearable:"",class:"mb-3"},null,8,["modelValue","label"]),t.mcpServers.length>0?(m(),u("div",ee,[h("h4",se,n(o.tm("form.mcpServersQuickSelect")),1),h("div",oe,[(m(!0),u(b,null,V(t.mcpServers,l=>(m(),f(y,{key:l.name,color:c.isServerSelected(l)?"primary":"default",variant:c.isServerSelected(l)?"flat":"outlined",size:"small",clickable:"",onClick:p=>c.toggleMcpServer(l),disabled:!l.tools||l.tools.length===0},{default:a(()=>[i(_,{start:"",size:"small"},{default:a(()=>[d("mdi-server")]),_:1}),d(" "+n(l.name)+" ",1),l.tools?(m(),f(A,{key:0,class:"ml-1"},{default:a(()=>[d(" ("+n(l.tools.length)+") ",1)]),_:2},1024)):g("",!0)]),_:2},1032,["color","variant","onClick","disabled"]))),128))])])):g("",!0),c.filteredTools.length>0?(m(),u("div",le,[i(U,{items:c.filteredTools,height:"300","item-height":"48"},{default:a(({item:l})=>[(m(),f(B,{key:l.name,density:"comfortable",onClick:p=>c.toggleTool(l.name)},{prepend:a(()=>[i(q,{"model-value":c.isToolSelected(l.name),onClick:H(p=>c.toggleTool(l.name),["stop"])},null,8,["model-value","onClick"])]),default:a(()=>[i(O,null,{default:a(()=>[d(n(l.name)+" ",1),l.mcp_server_name?(m(),f(y,{key:0,size:"x-small",color:"secondary",variant:"tonal",class:"ml-2"},{default:a(()=>[d(n(l.mcp_server_name),1)]),_:2},1024)):g("",!0)]),_:2},1024),l.description?(m(),f(W,{key:0},{default:a(()=>[d(n(c.truncateText(l.description,100)),1)]),_:2},1024)):g("",!0)]),_:2},1032,["onClick"]))]),_:1},8,["items"])])):!t.loadingTools&&t.availableTools.length===0?(m(),u("div",te,[i(_,{size:"48",color:"grey-lighten-2",class:"mb-2"},{default:a(()=>[d("mdi-tools")]),_:1}),h("p",ae,n(o.tm("form.noToolsAvailable")),1)])):!t.loadingTools&&c.filteredTools.length===0?(m(),u("div",ie,[i(_,{size:"48",color:"grey-lighten-2",class:"mb-2"},{default:a(()=>[d("mdi-magnify")]),_:1}),h("p",re,n(o.tm("form.noToolsFound")),1)])):g("",!0),t.loadingTools?(m(),u("div",ne,[i(G,{indeterminate:"",color:"primary"}),h("p",me,n(o.tm("form.loadingTools")),1)])):g("",!0),h("div",de,[h("h4",ce,[d(n(o.tm("form.selectedTools"))+" ",1),t.personaForm.tools===null?(m(),u("span",ue," ("+n(o.tm("form.allSelected"))+") ",1)):Array.isArray(t.personaForm.tools)?(m(),u("span",he," ("+n(t.personaForm.tools.length)+") ",1)):g("",!0)]),Array.isArray(t.personaForm.tools)&&t.personaForm.tools.length>0?(m(),u("div",pe,[(m(!0),u(b,null,V(t.personaForm.tools,l=>(m(),f(y,{key:l,size:"small",color:"primary",variant:"tonal",closable:"","onClick:close":p=>c.removeTool(l)},{default:a(()=>[d(n(l),1)]),_:2},1032,["onClick:close"]))),128))])):(m(),u("div",ge,n(o.tm("form.noToolsSelected")),1))])])):g("",!0)]),_:1})]),_:1}),i(S,{value:"dialogs"},{default:a(()=>[i(P,null,{default:a(()=>[i(_,{class:"mr-2"},{default:a(()=>[d("mdi-chat")]),_:1}),d(" "+n(o.tm("form.presetDialogs"))+" ",1),t.personaForm.begin_dialogs.length>0?(m(),f(y,{key:0,size:"small",color:"primary",variant:"tonal",class:"ml-2"},{default:a(()=>[d(n(t.personaForm.begin_dialogs.length/2),1)]),_:1})):g("",!0)]),_:1}),i(C,null,{default:a(()=>[h("div",fe,[h("p",_e,n(o.tm("form.presetDialogsHelp")),1)]),(m(!0),u(b,null,V(t.personaForm.begin_dialogs,(l,p)=>(m(),u("div",{key:p,class:"mb-3"},[i(k,{modelValue:t.personaForm.begin_dialogs[p],"onUpdate:modelValue":x=>t.personaForm.begin_dialogs[p]=x,label:p%2===0?o.tm("form.userMessage"):o.tm("form.assistantMessage"),rules:c.getDialogRules(p),variant:"outlined",rows:"2",density:"comfortable"},{append:a(()=>[i(v,{icon:"mdi-delete",variant:"text",size:"small",color:"error",onClick:x=>c.removeDialog(p)},null,8,["onClick"])]),_:2},1032,["modelValue","onUpdate:modelValue","label","rules"])]))),128)),i(v,{variant:"outlined","prepend-icon":"mdi-plus",onClick:c.addDialogPair,block:""},{default:a(()=>[d(n(o.tm("buttons.addDialogPair")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),i(j,null,{default:a(()=>[i(Q),i(v,{color:"grey",variant:"text",onClick:c.closeDialog},{default:a(()=>[d(n(o.tm("buttons.cancel")),1)]),_:1},8,["onClick"]),i(v,{color:"primary",variant:"flat",onClick:c.savePersona,loading:t.saving,disabled:!t.formValid},{default:a(()=>[d(n(o.tm("buttons.save")),1)]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const be=X(Y,[["render",ye],["__scopeId","data-v-af63bccc"]]);export{be as P};
