import{u as Y,z as _,c as R,ao as Z,a5 as P,o as r,g as u,b as a,w as t,M as A,N as $,e as c,t as l,f as d,P as G,A as h,l as M,Z as B,ai as U,C as w,F as E,h as F,a as D,b3 as q,a0 as Q,ag as X,ah as ee,p as ae,a1 as te,L as oe,a2 as se,G as ie,H as re}from"./index-77b120c5.js";import{C as le}from"./ConsoleDisplayer-dd1d5724.js";import{W as ne}from"./WaitingForRestart-fc0333aa.js";import{_ as ce}from"./_plugin-vue_export-helper-c27b6911.js";const De=[{title:"core.navigation.platforms",icon:"mdi-robot",to:"/"},{title:"core.navigation.providers",icon:"mdi-creation",to:"/providers"},{title:"core.navigation.config",icon:"mdi-cog",to:"/config"},{title:"core.navigation.toolUse",icon:"mdi-function-variant",to:"/tool-use"},{title:"core.navigation.extension",icon:"mdi-puzzle",to:"/extension"},{title:"core.navigation.knowledgeBase",icon:"mdi-book-open-variant",to:"/knowledge-base"},{title:"core.navigation.chat",icon:"mdi-chat",to:"/chat"},{title:"core.navigation.groups.more",icon:"mdi-dots-horizontal",children:[{title:"core.navigation.persona",icon:"mdi-heart",to:"/persona"},{title:"core.navigation.conversation",icon:"mdi-database",to:"/conversation"},{title:"core.navigation.sessionManagement",icon:"mdi-account-group",to:"/session-management"},{title:"core.navigation.dashboard",icon:"mdi-view-dashboard",to:"/dashboard/default"},{title:"core.navigation.console",icon:"mdi-console",to:"/console"}]}],N="astrbot_sidebar_customization";function de(){try{const i=localStorage.getItem(N);return i?JSON.parse(i):null}catch(i){return console.error("Error reading sidebar customization:",i),null}}function Ne(i){try{localStorage.setItem(N,JSON.stringify(i))}catch(k){console.error("Error saving sidebar customization:",k)}}function Oe(){try{localStorage.removeItem(N)}catch(i){console.error("Error clearing sidebar customization:",i)}}function Re(i){const k=de();if(!k)return i;const{mainItems:o,moreItems:p}=k,y=new Map;i.forEach(s=>{s.children?s.children.forEach(m=>{y.set(m.title,{...m})}):y.set(s.title,{...s})});const g=[];if(o.forEach(s=>{const m=y.get(s);m&&g.push(m)}),p&&p.length>0){const s={title:"core.navigation.groups.more",icon:"mdi-dots-horizontal",children:[]};p.forEach(m=>{const b=y.get(m);b&&s.children.push(b)}),g.push(s)}return g}const ue=i=>(ie("data-v-0a09ebf0"),i=i(),re(),i),me={class:"mb-4"},fe={key:0,class:"text-center py-8"},ge={class:"mb-4"},pe={class:"mb-4"},ve={key:1,class:"migration-in-progress"},_e={class:"text-center py-4"},he={class:"mb-4"},ye={class:"mb-4"},be={class:"console-container"},ke={key:2,class:"text-center py-8"},Ve={key:3,class:"text-center py-4"},xe={key:4},Ce={key:0,class:"text-center py-4"},we={key:1},Ee=ue(()=>h("small",null,"请选择该平台类型下您主要使用的平台适配器。",-1)),Se={__name:"MigrationDialog",setup(i,{expose:k}){const{t:o}=Y(),p=_(!1),y=_(!1),g=_(""),s=_(!1),m=_(!1),b=_(null),S=_([]),V=_({}),I=_(null);let C=null;const z=R(()=>{const e={};return S.value.forEach(n=>{const f=n.platform_type||n.type;e[f]||(e[f]={type:f,platforms:[]}),e[f].platforms.push(n)}),Object.values(e)}),L=R(()=>z.value.every(e=>V.value[e.type]));Z(p,e=>{e?O():(S.value=[],V.value={},g.value="",s.value=!1,m.value=!1,b.value=null)});const O=async()=>{y.value=!0,g.value="";try{const e=await P.get("/api/config/platform/list");e.data.status==="ok"?(S.value=e.data.data.platforms||[],z.value.forEach(n=>{n.platforms.length>0&&(V.value[n.type]=n.platforms[0].id)})):g.value=e.data.message||o("features.migration.dialog.loadError")}catch(e){console.error("Failed to load platforms:",e),g.value=o("features.migration.dialog.loadError")}finally{y.value=!1}},T=async()=>{s.value=!0;try{const e={};Object.entries(V.value).forEach(([f,v])=>{S.value.find(K=>K.id===v)&&(e[f]={platform_id:v,platform_type:f})}),console.log("Migration platform_id_map:",e);const n=await P.post("/api/update/migration",{platform_id_map:e});if(n.data.status==="ok")m.value=!0,b.value={success:!0,message:n.data.message||o("features.migration.dialog.success")};else throw new Error(n.data.message||o("features.migration.dialog.migrationError"))}catch(e){console.error("Migration failed:",e),g.value=e.message||o("features.migration.dialog.migrationError")}finally{s.value=!1}},j=()=>{p.value=!1,C&&C({success:!1,cancelled:!0})},J=()=>{p.value=!1,C&&C(b.value)},W=e=>`${e.name||e.id||"Unknown"}`,H=()=>{P.post("/api/stat/restart-core").then(()=>{I.value&&I.value.check()})};return k({open:()=>(p.value=!0,new Promise(e=>{C=e}))}),(e,n)=>(r(),u(E,null,[a(se,{modelValue:p.value,"onUpdate:modelValue":n[0]||(n[0]=f=>p.value=f),persistent:"","max-width":"600","max-height":"80vh",scrollable:""},{default:t(()=>[a(A,null,{default:t(()=>[a($,null,{default:t(()=>[c(l(d(o)("features.migration.dialog.title")),1)]),_:1}),a(G,{class:"pa-6"},{default:t(()=>{var f;return[h("p",me,l(d(o)("features.migration.dialog.warning")),1),m.value?(r(),u("div",fe,[a(M,{size:"64",color:"success",class:"mb-4"},{default:t(()=>[c("mdi-check-circle")]),_:1}),h("h3",ge,l(d(o)("features.migration.dialog.completed")),1),h("p",pe,l(((f=b.value)==null?void 0:f.message)||d(o)("features.migration.dialog.success")),1),a(B,{type:"info",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(M,null,{default:t(()=>[c("mdi-information")]),_:1})]),default:t(()=>[c(" "+l(d(o)("features.migration.dialog.restartRecommended")),1)]),_:1})])):s.value?(r(),u("div",ve,[h("div",_e,[a(U,{indeterminate:"",color:"primary",class:"mb-4"}),h("h3",he,l(d(o)("features.migration.dialog.migrating")),1),h("p",ye,l(d(o)("features.migration.dialog.migratingSubtitle")),1)]),h("div",be,[a(le,{ref:"consoleDisplayer",showLevelBtns:!1,style:{height:"300px"}},null,512)])])):y.value?(r(),u("div",ke,[a(U,{indeterminate:"",color:"primary",class:"mb-4"}),h("p",null,l(d(o)("features.migration.dialog.loading")),1)])):g.value?(r(),u("div",Ve,[a(B,{type:"error",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(M,null,{default:t(()=>[c("mdi-alert")]),_:1})]),default:t(()=>[c(" "+l(g.value),1)]),_:1}),a(w,{color:"primary",onClick:O},{default:t(()=>[c(l(d(o)("features.migration.dialog.retry")),1)]),_:1})])):(r(),u("div",xe,[z.value.length===0?(r(),u("div",Ce,[a(B,{type:"info",variant:"tonal"},{prepend:t(()=>[a(M,null,{default:t(()=>[c("mdi-information")]),_:1})]),default:t(()=>[c(" "+l(d(o)("features.migration.dialog.noPlatforms")),1)]),_:1})])):(r(),u("div",we,[(r(!0),u(E,null,F(z.value,v=>(r(),u("div",{key:v.type,class:"mb-6"},[v.platforms.length>1?(r(),D(A,{key:0,variant:"outlined"},{default:t(()=>[a(q,{class:"py-2"},{default:t(()=>[c(l(v.type),1)]),_:2},1024),a(Q),a(G,{style:{padding:"16px"}},{default:t(()=>[Ee,(r(),D(X,{modelValue:V.value[v.type],"onUpdate:modelValue":x=>V.value[v.type]=x,key:v.type,"hide-details":""},{default:t(()=>[(r(!0),u(E,null,F(v.platforms,x=>(r(),D(ee,{key:x.id,value:x.id,label:W(x),color:"primary",class:"mb-1"},null,8,["value","label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]))]),_:2},1024)]),_:2},1024)):ae("",!0)]))),128))]))]))]}),_:1}),a(te,{class:"px-6 py-4"},{default:t(()=>[a(oe),m.value?(r(),u(E,{key:0},[a(w,{color:"grey",variant:"text",onClick:J},{default:t(()=>[c(l(d(o)("core.common.close")),1)]),_:1}),a(w,{color:"primary",variant:"elevated",onClick:H},{default:t(()=>[c(l(d(o)("features.migration.dialog.restartNow")),1)]),_:1})],64)):(r(),u(E,{key:1},[a(w,{color:"grey",variant:"text",onClick:j,disabled:s.value},{default:t(()=>[c(l(d(o)("core.common.cancel")),1)]),_:1},8,["disabled"]),a(w,{color:"primary",variant:"elevated",onClick:T,disabled:!L.value||s.value,loading:s.value},{default:t(()=>[c(l(d(o)("features.migration.dialog.startMigration")),1)]),_:1},8,["disabled","loading"])],64))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ne,{ref_key:"wfr",ref:I},null,512)],64))}},Ae=ce(Se,[["__scopeId","data-v-0a09ebf0"]]);export{Ae as M,Re as a,Ne as b,Oe as c,de as g,De as s};
