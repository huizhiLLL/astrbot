import{u as S,ac as x,o as a,g as r,A as c,F as g,h as y,n as k,s as M,t as m,p as u,e as _,b as v,w as b,a as C,l as w,bi as B,C as L,ai as E}from"./index-77b120c5.js";import{M as H}from"./index-47e3efb7.js";import{H as f}from"./github-fdb230a7.js";import{_ as I}from"./_plugin-vue_export-helper-c27b6911.js";const R=new H({html:!1,breaks:!0,linkify:!0,highlight:function(e,n){if(n&&f.getLanguage(n))try{return f.highlight(e,{language:n}).value}catch(s){console.error("Highlight error:",s)}return f.highlightAuto(e).value}}),N={name:"MessageList",props:{messages:{type:Array,required:!0},isDark:{type:Boolean,default:!1},isStreaming:{type:Boolean,default:!1}},emits:["openImagePreview"],setup(){const{t:e}=S(),{tm:n}=x("features/chat");return{t:e,tm:n,md:R}},data(){return{copiedMessages:new Set,isUserNearBottom:!0,scrollThreshold:1,scrollTimer:null,expandedReasoning:new Set}},mounted(){this.initCodeCopyButtons(),this.initImageClickEvents(),this.addScrollListener(),this.scrollToBottom()},updated(){this.initCodeCopyButtons(),this.initImageClickEvents(),this.isUserNearBottom&&this.scrollToBottom()},methods:{toggleReasoning(e){this.expandedReasoning.has(e)?this.expandedReasoning.delete(e):this.expandedReasoning.add(e),this.expandedReasoning=new Set(this.expandedReasoning)},isReasoningExpanded(e){return this.expandedReasoning.has(e)},copyCodeToClipboard(e){navigator.clipboard.writeText(e).then(()=>{console.log("代码已复制到剪贴板")}).catch(n=>{console.error("复制失败:",n);const s=document.createElement("textarea");s.value=e,document.body.appendChild(s),s.select();try{document.execCommand("copy"),console.log("代码已复制到剪贴板 (fallback)")}catch(o){console.error("复制失败 (fallback):",o)}document.body.removeChild(s)})},copyBotMessage(e,n){const s=this.messages[n].content;let o="";if(e&&e.trim()){const l=document.createElement("div");l.innerHTML=e,o=l.textContent||l.innerText||e}s&&s.embedded_images&&s.embedded_images.length>0&&(o&&(o+=`

`),o+=`[包含 ${s.embedded_images.length} 张图片]`),s&&s.embedded_audio&&(o&&(o+=`

`),o+="[包含音频内容]"),o.trim()||(o="[媒体内容]"),navigator.clipboard.writeText(o).then(()=>{console.log("消息已复制到剪贴板"),this.showCopySuccess(n)}).catch(l=>{console.error("复制失败:",l);const i=document.createElement("textarea");i.value=o,document.body.appendChild(i),i.select();try{document.execCommand("copy"),console.log("消息已复制到剪贴板 (fallback)"),this.showCopySuccess(n)}catch(t){console.error("复制失败 (fallback):",t)}document.body.removeChild(i)})},showCopySuccess(e){this.copiedMessages.add(e),setTimeout(()=>{this.copiedMessages.delete(e)},2e3)},getCopyIcon(e){return this.copiedMessages.has(e)?"mdi-check":"mdi-content-copy"},isCopySuccess(e){return this.copiedMessages.has(e)},getCopyIconSvg(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'},getSuccessIconSvg(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"></polyline></svg>'},initCodeCopyButtons(){this.$nextTick(()=>{var n;(((n=this.$refs.messageContainer)==null?void 0:n.querySelectorAll("pre code"))||[]).forEach((s,o)=>{const l=s.parentElement;if(l&&!l.querySelector(".copy-code-btn")){const i=document.createElement("button");i.className="copy-code-btn",i.innerHTML=this.getCopyIconSvg(),i.title="复制代码",i.addEventListener("click",()=>{this.copyCodeToClipboard(s.textContent),i.innerHTML=this.getSuccessIconSvg(),i.style.color="#4caf50",setTimeout(()=>{i.innerHTML=this.getCopyIconSvg(),i.style.color=""},2e3)}),l.style.position="relative",l.appendChild(i)}})})},initImageClickEvents(){this.$nextTick(()=>{document.querySelectorAll(".markdown-content img").forEach(n=>{n.hasAttribute("data-click-enabled")||(n.style.cursor="pointer",n.setAttribute("data-click-enabled","true"),n.onclick=()=>this.$emit("openImagePreview",n.src))})})},scrollToBottom(){this.$nextTick(()=>{const e=this.$refs.messageContainer;e&&(e.scrollTop=e.scrollHeight,this.isUserNearBottom=!0)})},addScrollListener(){const e=this.$refs.messageContainer;e&&e.addEventListener("scroll",this.throttledHandleScroll)},throttledHandleScroll(){this.scrollTimer||(this.scrollTimer=setTimeout(()=>{this.handleScroll(),this.scrollTimer=null},50))},handleScroll(){const e=this.$refs.messageContainer;if(e){const{scrollTop:n,scrollHeight:s,clientHeight:o}=e,l=s-(n+o);this.isUserNearBottom=l<=this.scrollThreshold}},beforeUnmount(){const e=this.$refs.messageContainer;e&&e.removeEventListener("scroll",this.throttledHandleScroll),this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null)}}},A={class:"messages-container",ref:"messageContainer"},V={class:"message-list"},z={key:0,class:"user-message"},P={style:{"font-family":"inherit","white-space":"pre-wrap","word-wrap":"break-word"}},U={key:0,class:"image-attachments"},q=["src","onClick"],D={key:1,class:"audio-attachment"},F={controls:"",class:"audio-player"},$=["src"],j={key:1,class:"bot-message"},J={class:"bot-message-content"},O={class:"message-bubble bot-bubble"},G={key:0,class:"loading-container"},K={class:"loading-text"},Q={key:0,class:"reasoning-container"},W=["onClick"],X={class:"reasoning-label"},Y={key:0,class:"reasoning-content"},Z=["innerHTML"],ee=["innerHTML"],te={key:2,class:"embedded-images"},se=["src","onClick"],oe={key:3,class:"embedded-audio"},ne={controls:"",class:"audio-player"},ie=["src"],ae={key:0,class:"message-actions"};function re(e,n,s,o,l,i){return a(),r("div",A,[c("div",V,[(a(!0),r(g,null,y(s.messages,(t,d)=>(a(),r("div",{class:"message-item fade-in",key:d},[t.content.type=="user"?(a(),r("div",z,[c("div",{class:k(["message-bubble user-bubble",{"has-audio":t.content.audio_url}]),style:M({backgroundColor:s.isDark?"#2d2e30":"#e7ebf4"})},[c("pre",P,m(t.content.message),1),t.content.image_url&&t.content.image_url.length>0?(a(),r("div",U,[(a(!0),r(g,null,y(t.content.image_url,(h,p)=>(a(),r("div",{key:p,class:"image-attachment"},[c("img",{src:h,class:"attached-image",onClick:T=>e.$emit("openImagePreview",h)},null,8,q)]))),128))])):u("",!0),t.content.audio_url&&t.content.audio_url.length>0?(a(),r("div",D,[c("audio",F,[c("source",{src:t.content.audio_url,type:"audio/wav"},null,8,$),_(" "+m(o.t("messages.errors.browser.audioNotSupported")),1)])])):u("",!0)],6)])):(a(),r("div",j,[v(B,{class:"bot-avatar",size:"36"},{default:b(()=>{var h;return[s.isStreaming&&d===s.messages.length-1?(a(),C(E,{key:0,index:d,indeterminate:"",size:"28",width:"2"},null,8,["index"])):((h=s.messages[d-1])==null?void 0:h.content.type)!=="bot"?(a(),C(w,{key:1,size:"64",color:"#8fb6d2"},{default:b(()=>[_("mdi-star-four-points-small")]),_:1})):u("",!0)]}),_:2},1024),c("div",J,[c("div",O,[t.content.isLoading?(a(),r("div",G,[c("span",K,m(o.tm("message.loading")),1)])):(a(),r(g,{key:1},[t.content.reasoning&&t.content.reasoning.trim()?(a(),r("div",Q,[c("div",{class:"reasoning-header",onClick:h=>i.toggleReasoning(d)},[v(w,{size:"small",class:"reasoning-icon"},{default:b(()=>[_(m(i.isReasoningExpanded(d)?"mdi-chevron-down":"mdi-chevron-right"),1)]),_:2},1024),c("span",X,m(o.tm("reasoning.thinking")),1)],8,W),i.isReasoningExpanded(d)?(a(),r("div",Y,[c("div",{innerHTML:o.md.render(t.content.reasoning),class:"markdown-content reasoning-text"},null,8,Z)])):u("",!0)])):u("",!0),t.content.message&&t.content.message.trim()?(a(),r("div",{key:1,innerHTML:o.md.render(t.content.message),class:"markdown-content"},null,8,ee)):u("",!0),t.content.embedded_images&&t.content.embedded_images.length>0?(a(),r("div",te,[(a(!0),r(g,null,y(t.content.embedded_images,(h,p)=>(a(),r("div",{key:p,class:"embedded-image"},[c("img",{src:h,class:"bot-embedded-image",onClick:T=>e.$emit("openImagePreview",h)},null,8,se)]))),128))])):u("",!0),t.content.embedded_audio?(a(),r("div",oe,[c("audio",ne,[c("source",{src:t.content.embedded_audio,type:"audio/wav"},null,8,ie),_(" "+m(o.t("messages.errors.browser.audioNotSupported")),1)])])):u("",!0)],64))]),t.content.isLoading?u("",!0):(a(),r("div",ae,[v(L,{icon:i.getCopyIcon(d),size:"small",variant:"text",class:k(["copy-message-btn",{"copy-success":i.isCopySuccess(d)}]),onClick:h=>i.copyBotMessage(t.content.message,d),title:o.t("core.common.copy")},null,8,["icon","class","onClick","title"])]))])]))]))),128))])],512)}const ue=I(N,[["render",re],["__scopeId","data-v-49d2ef47"]]);export{ue as M};
